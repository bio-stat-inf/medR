---
title: "Диаграммы последовательности"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 1
    code_folding: hide
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	cache = TRUE
)
```

```{r packages, message=FALSE, warning=FALSE}
library(dplyr)
require(DiagrammeR)
```

# Диаграммы последовательности

На диаграммах последовательности отображается жизненный цикл одного
объекта или нескольких, а также их взаимодействие. Диаграммы
последовательности состоят из актеров в виде прямоугольников и
взаимодействий в виде вертикальных «линий жизни».

В Mermaid диаграммы последовательности задаются с помощью ключевого
слова `sequenceDiagram`:

```{r}
mermaid("
sequenceDiagram
    Alice->>John: Hello John, how are you?
    John-->>Alice: Great!
    Alice->>John: See you later!
  
")
```

Актеров можно объявлять неявно сразу во время указания отношений, а
можно сначала объявить всех участников с помощью ключевого слова
participant, а потом отмечать отношения.

```{r}
mermaid("
sequenceDiagram
    participant Ваня
    participant Петя
    Ваня->>Петя: Привет, Петя
    Петя->>Ваня: Привет, Ваня
")
```

Каждый раз писать имя актера может быть не удобно и долго, особенно если
схема состоит из десятка разных актеров. Для этих целей в Mermaid есть
псевдонимы. Имя актера можно сократить до нескольких букв или буквенных
идентификаторов.

```{r}
mermaid("
sequenceDiagram
    participant V as Ваня
    participant P as Петя
    V->>P: Привет, Петя
    P->>V: Привет, Ваня
")
```

Связи и сообщения могут отображаться в виде сплошных или пунктирных
линий. Общий вид выглядит следующим образом:

> `[Актер][Стрелка][Актер]:Текст сообщения`

| Тип    | Описание                              |
|--------|---------------------------------------|
| -\>    | Сплошная линия без стрелки            |
| --\>   | Пунктирная линия без стрелки          |
| -\>\>  | Сплошная линия со стрелкой            |
| --\>\> | Пунктирная линия со стрелкой          |
| -x     | Сплошная линия с крестиком на конце   |
| --x    | Пунктирная линия с крестиком на конце |

Актера явно можно активировать и деактивировать, отмечая область его
действия. Осуществляется это с помощью ключевых слов activate и
deactivate. Активации можно накладывать друг на друга.

```{r}
mermaid("
sequenceDiagram
    participant V as Ваня
    participant P as Петя
    V->>P: Привет, Петя
    activate P
    P->>V: Привет, Ваня
    deactivate P
")
```

Доступна и сокращенная запись в виде знаков «+/-» на конце стрелок,
результат рендеринга будет идентичен:

```{r}
mermaid("
sequenceDiagram
    participant V as Ваня
    participant P as Петя
    V-)+P: Привет, Петя
    P->>-V: Привет, Ваня
")
```

Диаграммы последовательности можно снабжать заметками с помощью общего
вида записи:

> `Note [ right of | left of | over ] [Актер]:` Текст заметки

Если ключевые слова `right of` и `left` of уже встречались нам, то слово
over новое. Оно позволяет размещать заметку сразу на нескольких актерах.

```{r}
mermaid("
sequenceDiagram
    participant V as Ваня
    participant P as Петя
    V->>+P: Привет, Петя
    P->>-V: Привет, Ваня
    Note over V,P: Заметка
")
```

Часто одно и то же действие происходит в цикле и активируется с
определенным интервалом. В Mermaid циклы задаются с помощью ключевого
слова loop:

> `loop Текст цикла' '… действие …' 'end`

К примеру:

```{r}
mermaid("
sequenceDiagram
    participant V as Ваня
    participant P as Петя
    V->>P: Привет, Петя
    loop Каждое утро
    P->>V: Привет, Ваня
    end
")
```

Альтернативные сценарии и условия обозначаются следующей конструкцией:

> `alt Описание`
>
> `… действие …`
>
> `else`
>
> `… действие …`
>
> `end`

Необязательные опциональные сценарии задаются без else:

> `opt Описание`\
> `… действие …' 'end`

Пример:

```{r}
mermaid("
sequenceDiagram
    participant V as Ваня
    participant P as Петя
    V->>P: Петя, как дела?
    alt Если хорошо
        P->>V: Все отлично!
    else
        P->>V: Все плохо :с
    end
    opt Если все сильно раздражает
    P->>V: Отвали, Ваня!
    end
")
```

Можно указать параллельные действия. Для этого есть ключевое слово par:

> `par [Действие 1]… описание … and [Действие 2]… описание …and [Действие N]… описание …end`

К примеру так:

```{r}
mermaid("
sequenceDiagram
    participant V as Ваня
    participant P as Петя
    participant I as Ирина

    par Ваня и Петя
        V->>P: Привет, Петя
    and Ваня и Ирина 
        V->>I: Привет, Ирина
    end
")
```

Фону можно добавлять кастомизированные цвета с помощью RGB и RGBA кодов:

> `rect rgb(0, 255, 0)' '… содержимое …' 'endrect rgba(0, 0, 255, .1)' '… содержимое …' 'end`

К примеру:

```{r}
mermaid("
sequenceDiagram
    participant V as Ваня
    participant P as Петя
    participant I as Ирина

    rect rgb(191, 223, 255)
    par Ваня и Петя
        V->>P: Привет, Петя
    and Ваня и Ирина 
        V->>I: Привет, Ирина
    end
    end
")
```

Действия на диаграмме можно автоматически пронумеровать с помощью
ключевого слова `autonumber` в начале кода:

```{r}
mermaid("
sequenceDiagram;
    participant V as Ваня
    participant P as Петя
    participant I as Ирина

    autonumber
    par Ваня и Петя
        V->>P: Привет, Петя
    and Ваня и Ирина 
        V->>I: Привет, Ирина
    end
    loop Каждые полчаса
        V->>I: Сколько времени?
    end
")
```

```{r}
mermaid("
sequenceDiagram;
    participant V as Ваня
    participant P as Петя
    participant I as Ирина

    V->>P: Привет, Петя
    V->>I: Привет, Ирина
    loop Каждые полчаса
        V->>I: Сколько времени?
    end
")
```

# 4.4 Basic Sequence Diagram

```{r}
mermaid("
sequenceDiagram
    Alice ->> Bob: Hello Bob, how are you?
    Bob-->>John: How about you John?
    Bob--x Alice: I am good thanks!
    Bob-x John: I am good thanks!
    Note right of John: Bob thinks a long<br/>long time, so long<br/>that the text does<br/>not fit on a row.

    Bob-->Alice: Checking with John...
    Alice->John: Yes... John, how are you?
")

```

# 4.5 Message to Self in Loop

```{r}
mermaid("
sequenceDiagram
    participant Alice
    participant Bob
    Alice->>John: Hello John, how are you?
    loop Healthcheck
        John->>John: Fight against hypochondria
    end
    Note right of John: Rational thoughts<br/>prevail...
    John-->>Alice: Great!
    John->>Bob: How about you?
    Bob-->>John: Jolly good!
")

```

2.6 Loops Express loops in a sequence diagram by the notation loop

```{r}
mermaid("
sequenceDiagram
    Alice->John: Hello John, how are you?
    loop Every minute
        John-->Alice: Great!
    end
")
 
```

# 2.7 Alt

```{r}
mermaid("
sequenceDiagram
    Alice->>John: Hello John, how are you?
    alt is sick
        John->>Alice: Not so good :(
    else is well
        John->>Alice: Feeling fresh like a daisy
    end
    opt Extra response
        John->>Alice: Thanks for asking
    end
")
 
```

# 2.4 Activations

Activate and deactivate an actor.

```{r}
mermaid("
sequenceDiagram
participant Event as Very long name goes here
participant API as Some API
participant API2 as A different API
participant Client as Another very long name goes here

activate Event
Event ->> Event: Something important happens
Note over Event,Client: Some explanation goes here
activate Client
Event --x Client: Publish event
deactivate Event

deactivate Client
")
 
```

```{r}
mermaid("
sequenceDiagram
    Alice->>+John: Hello John, how are you?
    Alice->>+John: John, can you hear me?
    John-->>-Alice: Hi Alice, I can hear you!
    John-->>-Alice: I feel great!
")
 
```
