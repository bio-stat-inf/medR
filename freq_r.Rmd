---
title: "Статистика частот"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 1
    #code_folding: hide
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	cache = TRUE
)
```

```{r packages, message=FALSE, warning=FALSE}
#library(dplyr)
#require(ggplot2)
library(gmodels)
```

# Таблицы частот и таблицы сопряженности

В этом разделе мы рассмотрим таблицы частот и таблицы сопряженности для
категориальных переменных, а также познакомимся с тестами на
независимость, мерами связи и способами графического представления
результатов. Мы будем использовать команды, реализованные в базовой
версии R, наряду с командами из пакетов `vcd` и `gmodels`. В
представленных ниже примерах A, B и C обозначают категориальные
переменные. В примерах этого раздела использован набор данных
`Arthritis` из пакета `vcd`. Эти данные опубликованы Kock & Edward
(1988) и представляют собой результаты клинического исследования нового
способа лечения ревматоидного артрита двойным слепым методом.

Вот первые несколько наблюдений:

```{r}
library(vcd)
head(Arthritis)
```

Способ лечения (Treatment: плацебо -- Placebo и лекарство -- Treated),
пол (Sex: мужской -- Male и женский -- Female) и степень улучшения
состояния больных (Improved: None -- нет, Some -- некоторое, Marked --
заметное) -- это категориальные факторы. В следующем подразделе мы
создадим таблицы частот и сопряженности для этих данных.

# Создание таблиц частот

В R реализовано несколько методов создания таблиц частот и
сопряженности. Самые важные функции перечислены в табл. 7.1.

**Таблица 7.1.** Функции для создания и преобразования таблиц
сопряженности

| Функция                              | Описание                                                                                                       |
|-------------------|-----------------------------------------------------|
| `table(*var1*, *var2*, ..., *varN*)` | Создает N-мерную таблицу сопряженности для N категориальных переменных (факторов)                              |
| `xtabs(formula, data)`               | Создает N-мерную таблицу сопряженности на основе формулы и матрицы или таблицы данных                          |
| `prop.table(*table*, *margins*)`     | Представляет значения таблицы в виде долей от значений крайнего поля таблицы, задаваемого параметром *margins* |
| `margin.table(*table*, *margins*)`   | Суммирует значения таблицы по строкам или столбцам `(определяется параметром *margins*)`                       |
| `addmargins(table, margins)`         | Вычисляет описательные статистики *margins* (суммы по умолчанию) для таблицы                                   |
| `ftable(*table*)`                    | Создает компактную «плоскую» таблицу сопряженности                                                             |

В следующих подразделах мы будем использовать все эти функции для
исследования категориальных переменных. Мы начнем с вычисления простых
частот, потом построим таблицы сопряженности для двух переменных и
закончим созданием таблиц сопряженности для нескольких переменных. В
качестве первого шага мы создадим таблицу при помощи функций *table()* и
*xtabs()*, а затем будем изменять эту таблицу при помощи других функций.

# Таблицы для одной переменной

Частоты значений одной переменной можно рассчитать при помощи функции
`table()`. Вот пример:

```{r}
mytable <- with(Arthritis, table(Improved)) 
mytable
```

Эти частоты можно преобразовать в доли от целого при помощи команды
`prop.table()`:

```{r}
prop.table(mytable)
```

Или в проценты, используя prop.table()*100: Или в проценты, используя
prop.table()*100:

```{r}
prop.table(mytable)*100
```

Отсюда видно, что у половины пациентов после лечения произошло
определенное улучшение состояния `(16.7 + 33.3)`.

# Таблицы для двух переменных

В случае двух переменных формат применения функции table() таков:

> `mytable <- table(A, B)`

где A -- это переменная, значениям которой соответствуют строки таблицы
сопряженности, а B -- столбцы. В качестве альтернативы можно
воспользоваться функцией `xtabs()`, которая позволяет при создании
таблицы сопряженности вводить данные в виде формулы. Вот формат ее
применения:

> `mytable <- xtabs(~ A + B, data=mydata)`

где `mydata` -- это матрицы или таблица данных. В общем случае
переменные, для которых строится таблица сопряженности, находятся в
правой части формулы (то есть справа от знака `~`) и разделяются знаками
`+`. Если переменная находится в левой части формулы, предполагается,
что это вектор с частотами значений (удобно, если вы их уже вычислили).

Для набора данных `Arthritis` у вас получится такая таблица:

```{r}
mytable <- xtabs(~ Treatment+Improved, data=Arthritis)
mytable
```

При помощи команд `margin.table()` и `prop.table()` можно рассчитать
соответственно частоты и доли от целого по столбцам или строкам. При
суммировании и вычислении долей по строкам получится следующее:

```{r}
margin.table(mytable, 1)
prop.table(mytable, 1)
```

Индекс 1 относится к первой переменной в формате применения функции
`table()`. Рассматривая полученную таблицу, вы можете заметить, что у
51% пациентов, получавших настоящее лекарство, наступило заметное
улучшение. Для сравнения: такой эффект наступил только у 16% получавших
плацебо пациентов. Вычисление сумм и долей от целого для столбцов
выглядит так:

```{r}
margin.table(mytable, 2)
prop.table(mytable, 2)
```

В этом случае индекс 2 относится ко второй переменной в формате
применения функции `table()`. Доли от целого для ячеек таблицы
рассчитываются так:

```{r}
prop.table(mytable)
```

Можно использовать функцию `addmargins()` для добавления сумм по
столбцам или строкам:

```{r}
addmargins(mytable)
addmargins(prop.table(mytable))
```

При использовании функции `addmargins()` по умолчанию вычисляются суммы
и для столбцов, и для строк таблицы. В противоположность этому команда

```{r}
addmargins(prop.table(mytable, 1), 2)
```

позволяет вычислить сумму только для строк. Аналогично команда

```{r}
addmargins(prop.table(mytable, 2), 1)
```

вычисляет суммы только для столбцов. Из этой таблицы видно, что 25%
пациентов, чье состояние заметно улучшилось после лечения, получали
плацебо.

**Замечание.** Функция `table()` по умолчанию игнорирует пропущенные
значения. Для добавления пропущенных значений в таблицу сопряженности в
качестве одного из значений используйте опцию `useNA="ifany"`.

Третий способ создания таблиц сопряженности для двух переменных
заключается в использовании функции `CrossTable()` из пакета `gmodels`.
Эта функция создает такую же таблицу, как функции PROC FREQ в SAS или
CROSSTABS в SPSS. Пример представлен в программном коде 7.11.

**Программный код 7.11.** Построение таблицы сопряженности для двух
переменных при помощи функции `CrossTable()`:

```{r}
library(gmodels)
CrossTable(Arthritis$Treatment, Arthritis$Improved)
```

У функции `CrossTable()` есть опции вычислять проценты (по строкам, по
столбцам, по ячейкам); округлять числа до заданного числа знаков после
запятой; проводить тесты хи-квадрат, Фишера и Мак-Немара на
независимость; вычислять ожидаемые значения и остатки (по Пирсону,
стандартизованные, скорректированные стандартизованные); учитывать
пропущенные значения; добавлять подписи в виде названий строк и
столбцов; форматировать результат в стиле SAS и SPSS. Более подробную
информацию можно получить, набрав `help(CrossTable)`.

Если у нас есть больше двух категориальных переменных, нужно строить
многомерные таблицы сопряженности. Давайте теперь рассмотрим их.

### Многомерные таблицы

Функции `table()` и `xtabs()` можно использовать для создания
многомерных таблиц сопряженности для трех и более категориальных
переменных. Функции `margin.table()`, `prop.table()` и `addmargins()`
тоже можно применять к многомерным таблицам.

Кроме того, функция `ftable()` позволяет выводить многомерные таблицы на
экран в компактном и привлекательном виде. Пример приведен в программном
коде 7.12.

**Программный код 7.12.** Трехмерная таблица сопряженности

**#1** Групповые частоты

```{r}
mytable <- xtabs(~ Treatment+Sex+Improved, data=Arthritis)
mytable
ftable(mytable)
```

**#2** Сумма частот по строками столбцам

```{r}
margin.table(mytable, 1)
margin.table(mytable, 2)
margin.table(mytable, 3)
```

**#3** Сумма частот всех сочетаний значений столбцов Treatment и
Improved

```{r}
margin.table(mytable, c(1, 3))
```

**#4** Сумма частот всех сочетаний значений столбцов Treatment и Sex

```{r}
ftable(prop.table(mytable, c(1, 2)))
ftable(addmargins(prop.table(mytable, c(1, 2)), 3))
```

Выражение **#1** позволяет вычислить частоты для всех сочетаний трех
факторов. Также видно, что команда `ftable()` позволяет представить
результаты в более компактном и привлекательном виде.

Выражение **#2** рассчитывает частоты для отдельных факторов. Поскольку
исходная таблица была создана при помощи формулы
`~ Treatment+Sex+Improved`, то индекс 1 соответствует переменной
`Treatment`, индекс 2 -- переменной `Sex`, а индекс 3 -- переменной
`Improved`.

Выражение **#3** позволяет вычислить частоты встречаемости всех
сочетаний значений `Treatment` и `Improved`, объединив данные для мужчин
и женщин. Доля пациентов с разной степенью улучшения для каждого
сочетания типа лечения и пола вычислена при помощи команды `q`. Здесь
видно, что заметное улучшение наступило у 36% мужчин и 69% женщин,
которые получали настоящее лекарство. В общем случае частоты вычисляются
так, чтобы их сумма для всех значений не указанного внутри команды
`prop.table()` фактора (в данном случае `Improved`) была равна единице.
Это видно в последнем примере, где мы суммируем частоты по строкам.

Если вы хотите представить результат в процентах, а не долях единицы,
можете умножить все значения полученной таблицы на 100.

Например, команда

```{r}
ftable(addmargins(prop.table(mytable, c(1, 2)), 3)) * 100
```

создает такую таблицу:

В то время как таблицы сопряженности содержат информацию о частотах всех
сочетаний значений факторов, вам, возможно, также интересно, связаны ли
эти факторы между собой или они независимы. Тесты на независимость
обсуждаются в следующем разделе.
